---
title: "Prolific percentage compute"
output: html_notebook
---

Dated July 2020
by D V M Bishop

Script to compute for individual journals the percentage of publications contributed by the most prolific author.
Now modified to make a datatable with all authors who published 15+ papers in 5 year period


```{r setup, include=FALSE}
require(tidyverse)
require(gdata)
require(dmm) #for unfactor
require(stringr)
require(varhandle) #for unfactor
```
# Background
The script uses the wosr package. With this, it is possible to obtain a link that allows one to pull in records from queries to Web of Science, provided the IP address has a legitmate WoS licence.  
https://www.rdocumentation.org/packages/wosr/versions/0.3.0

# Journals
We make lists to focus on behavioural sciences/psychology by specific publishers


Obtain session identification code. You only need do this once per session. In my experience, it sometimes fails, even when accessing the script from a valid IP address with access to Web of Science. If you are working remotely and have access to WoS, you need to use VPN.

```{r wosr.session}

require(wosr) 
#This gets the crucial session identifiers for using wosr
sid<- auth(username = NULL,
           password = NULL)


```




# WOSR Function
This function below now pulls in papers specified by a given query.  
It is advisable to use query_wos to find out how many records there are in a search - it can take hours if this is a large number, so you may want to specify an upper limit when deciding whether to proceed with search.

Next chunk now modified to find all authors with 15+ papers

```{r pullpapersfunction}

pullpapers<-function(query){
  # It's best to see how many records your query matches before actually
  # downloading the data. To do this, call query_wos before running pull_wos:
  myq<-query_wos(query, sid = sid) # shows N matching publications
  #initialise in case of zero count
  nrec<-0
  mymax<-0
  thisau<-''
  thisnum=0
  if(myq$rec_cnt>0){
    if (myq$rec_cnt<3000){
    wos_data<-pull_wos(query,sid = sid) #key instruction for pulling in data
    
    nrec<-nrow(wos_data$publication)
    myau<-wos_data$author #identify all authors
    myt<-table(myau$display_name) #tabulate frequency of authors
    mytt<-data.frame(myt)
    highcut <- 14
    w<-which(mytt$Freq> highcut) #find the authors with papers > highcut
    thisau=NA
    
    if(length(w)>0) {thisau=mytt[w,1]
    thisnum = mytt[w,2]} #thisau has all authors with 15+ papers
    }#end if myq3000
  }#end ifmy0
  return(list(myq$rec_cnt,mymax,thisau,thisnum)) #function returns N papers found, N for author with maximum N papers, and identity of that author
} 
```


We'll now compare various journals. 
We have to specify a query in the correct format for wosr to recognise.
There are some examples in wosr help.


```{r makedt}
myfile<-'springerlist'
jlist<-read.csv(paste0(myfile,'.csv'),stringsAsFactors=F)
myj<-jlist[,1]
journals <- data.frame(Journal=character(),
                Narticle=integer(), 
                 Author=character(), 
                 Nau.paper=integer())


for (j in 1:length(myj)){
  thisj <- myj[j]
  print(j)
  print(thisj)
  mypy <- "(2015-2020)" #select range of publication years
  #DT is document type - here specify Article or Review
  query <- paste('SO = \"', thisj,'\" AND PY = ',mypy,' AND DT=(Article OR Review)')
  mybits <- pullpapers(query)
   aubits<-as.character(unlist(mybits[[3]]))
   naubit <-mybits[[4]]
   myrow<-length(aubits)
   if(myrow>0){
   addbit <- data.frame(Journal=character(myrow),
                 Narticle=integer(myrow), 
                 Author=character(myrow), 
                 Nau.paper=integer(myrow))
  addbit$Journal<-unfactor(addbit$Journal)
  addbit$Author <- unfactor(addbit$Author)
  addbit$Journal[1:myrow]<-thisj
  addbit$Narticle[1:myrow]<-unlist(mybits[1])

  addbit$Author[1:myrow]<-aubits
   addbit$Nau.paper[1:myrow]<-naubit
  journals<-rbind(journals,addbit)
   }
} #next j

journals$p_prolific <- round(100*journals$Nau.paper/journals$Narticle,2)
write.csv(journals,paste0(myfile,'_out.csv'),row.names=F)

```

